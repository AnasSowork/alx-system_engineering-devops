#!/usr/bin/env bash
# This script configures Nginx to run as the nginx user and listen on all active IPs on port 8080.

if ! command -v nginx &>/dev/null; then
    echo "Nginx is not installed"
    exit 1
fi

cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak
chown -R nginx:nginx /var/log/nginx /var/lib/nginx /var/www/html
sed -i 's/user  nginx;/user  nginx nginx;/g' /etc/nginx/nginx.conf
service nginx restart
ps auxff | grep 'nginx: master process' | grep -v grep | grep -q nginx
if [ $? -ne 0 ]; then
    echo "Nginx is not running as nginx user"
    exit 1
fi

nc -z 0 8080
if [ $? -ne 0 ]; then
    echo "Nginx is not listening on port 8080"
    exit 1
fi

echo "Nginx configured successfully to run as nginx user and listen on port 8080"
